@{
    Layout = "/Views/Shared/_LayoutClientes.cshtml";
    ViewData["Title"] = "Generar Pedido";
}

@section Head {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/Home/PedidoCliente.css" asp-append-version="true" />
}

<section class="fondo-form">
    <form asp-action="PedidoCliente" class="formulario-container">
        <div class="caja-pedido">
            <div class="form">
                <h1 class="form-titulo">Realiza tu Pedido</h1>
                <div class="info-pedido">
                    <label name ="cliente.NombreCompletoCliente">Nombre Completo</label>
                    <input name="cliente.NombreCompletoCliente" type="text" id="nombre-completo-cliente" placeholder="Ingrese su nombre completo" class="inputs" />
                </div>
                <div class="info-pedido">
                    <label name="cliente.CorreoCliente">Correo</label>
                    <input name="cliente.CorreoCliente" type="email" id="correo-cliente" placeholder="Ingrese su correo electronico" class="inputs" />
                </div>
                <div class="info-pedido">
                    <label name="cliente.PaisCliente">Pais</label>
                    <div id="pais-container">
                        <select name="cliente.PaisCliente" style="width: 100%;" asp-items="ViewBag.Paises"></select>
                    </div>
                </div>
                <div class="info-pedido">
                    <label name="pedido.FechaEntrega" class="control-label">Fecha estimada</label>
                    <input id="fecha-estimada" name="pedido.FechaEntrega" class="inputs" type="date" />
                </div>
                <div class="info-pedido">
                    <label>Prenda</label>
                    <input type="text" id="desc-prenda" placeholder="Ingrese la prenda" class="inputs" />
                </div>
                <div class="info-pedido">
                    <label>Cantidad</label>
                    <input type="number" step="1" id="cantidad-prenda" placeholder="Ingrese la cantidad" class="inputs" />
                </div>
                <div class="info-pedido">
                    <label>Descripción detallada</label>
                    <textarea id="desc-detallada-prenda" placeholder="Ingrese los detalles" class="inputs"></textarea>
                </div>
                <div class="btn-container">
                    <button class="btn" id="btn-agregar">Agregar</button>

                    <input type="hidden" id="contenido-html" name="tablaHTML" />
                    <button type="submit" class="btn" id="btn-finalizar">Finalizar</button>
                </div>
            </div>
            <div class="detalles" id="detalles">
                <h1 class="form-titulo-tabla">Pedidos Realizados</h1>
                <table class="table" id="tabla-pedido">
                    <thead>
                        <tr>
                            <th>Prenda</th>
                            <th>Descripción detallada</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="module">
        import toastMessage from '/js/toastMessage.js';

        document.addEventListener("DOMContentLoaded", function () {
            const errorMessage = "@ViewBag.ErrorMessage";
            errorMessage && toastMessage(errorMessage, "error");

            const doneMessage = "@ViewBag.DoneMessage";
            doneMessage && toastMessage(doneMessage, "success");
        });
    </script>
    <script>
        $(document).ready(() => {
            let detalleCount = 0;
            
            const today = new Date().toISOString().split('T')[0];
                        
            document.getElementById('fecha-estimada').min = today;
            document.getElementById('fecha-estimada').value = today;
            
            $("#btn-finalizar").on("click", (e) => {
                e.preventDefault();
                
                // Obtener la fecha estimada ingresada por el usuario
                const fechaEstimada = new Date($("#fecha-estimada").val());

                // Obtener el año actual más 10 años
                const limiteAnio = new Date().getFullYear() + 10;
                const fechaLimite = new Date(limiteAnio, 0, 1);

                if (fechaEstimada >= fechaLimite) {
                    toastMessage("La fecha estimada debe ser menor", "error");
                    return;
                }
                
                // Si la validación pasa, puedes proceder con el envío del formulario
                $("form").submit();
            });

            $("#btn-agregar").on("click", (e) => {
                e.preventDefault();
                
                if (validarCampos()) {
                    $("#tabla-pedido > tbody").append(
                        $("<tr>").append(
                            $("<td>").append(
                                $("<input>")
                                .attr("type", "text")
                                .attr("name", "detalles[" + detalleCount + "].DescPrenda")
                                .addClass("form-control")
                                .val($("#desc-prenda")
                                .val())
                            ),
                            $("<td>").append(
                                $("<input>")
                                .attr("type", "text")
                                .attr("name", "detalles[" + detalleCount + "].DetallesPrenda")
                                .addClass("form-control")
                                .val($("#desc-detallada-prenda")
                                .val())
                            ),
                            $("<td>").append(
                                $("<input>")
                                .attr("type", "number")
                                .attr("name", "detalles[" + detalleCount + "].CantidadPrenda")
                                .addClass("form-control")
                                .val($("#cantidad-prenda")
                                .val())
                            )
                        )
                    );
    
                    $("#desc-prenda").val("");
                    $("#desc-detallada-prenda").val("");
                    $("#cantidad-prenda").val("");
                    $("#desc-prenda").focus();
    
                    detalleCount++;   
                }
            });
            
            const validarCampos = () => {
                const campos = [
                    {
                        id: "#desc-prenda",
                        mensaje: "Ingrese la prenda"
                    },
                    {
                        id: "#desc-detallada-prenda",
                        mensaje: "Ingrese los detalles de la prenda"
                    },
                    {
                        id: "#cantidad-prenda",
                        mensaje: "Ingrese la cantidad"
                    }
                ];
            
                for (const campo of campos) {
                    const valor = $(campo.id).val().trim();
            
                    if (valor === "") {
                        toastMessage(campo.mensaje, "error");
                        return false;
                    }
                }
            
                return true;
            };

            $("select").select2();
        });
    </script>
}
